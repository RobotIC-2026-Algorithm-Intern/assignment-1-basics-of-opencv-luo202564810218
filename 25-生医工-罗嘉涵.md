import cv2
import numpy as np

# 定义颜色HSV范围
# 红色
red1_low = np.array([0, 120, 70])
red1_up = np.array([10, 255, 255])
red2_low = np.array([170, 120, 70])
red2_up = np.array([180, 255, 255])
# 蓝色
blue_low = np.array([100, 120, 50])
blue_up = np.array([130, 255, 255])
# 紫色
purple_low = np.array([130, 80, 50])
purple_up = np.array([160, 255, 255])

# 定义ROI区域
roi_x, roi_y = 180, 130
roi_width, roi_height = 250, 180

# 定义最小像素数量阈值
min_pixel_threshold = 1000

def get_ball_state(frame):
    """检测球的状态并返回"""
    # 旋转帧
    rotated_frame = cv2.rotate(frame, cv2.ROTATE_180)
    
    # 提取ROI区域
    roi = rotated_frame[roi_y:roi_y+roi_height, roi_x:roi_x+roi_width]
    
    # 转换到HSV颜色空间
    hsv = cv2.cvtColor(roi, cv2.COLOR_BGR2HSV)
    
    # 检测各种颜色
    red_mask1 = cv2.inRange(hsv, red1_low, red1_up)
    red_mask2 = cv2.inRange(hsv, red2_low, red2_up)
    red_mask = red_mask1 + red_mask2
    red_pixel_count = cv2.countNonZero(red_mask)
    
    blue_mask = cv2.inRange(hsv, blue_low, blue_up)
    blue_pixel_count = cv2.countNonZero(blue_mask)
    
    purple_mask = cv2.inRange(hsv, purple_low, purple_up)
    purple_pixel_count = cv2.countNonZero(purple_mask)
    # 确定主要颜色
    color_counts = {
        'Red': red_pixel_count,
        'Blue': blue_pixel_count,
        'Purple': purple_pixel_count
    }
    
    # 找到像素数量最多的颜色
    dominant_color = max(color_counts, key=color_counts.get)
    dominant_count = color_counts[dominant_color]
    
    # 判断是否有球
    if dominant_count < min_pixel_threshold:
        return "NoBall"
    else:
        return dominant_color
# 定义视频处理函数
def video_process(videopath):
    """处理视频，检测球的状态并显示"""
    # 从output.avi中逐帧读取并将当前帧存为frame
    cam = cv2.VideoCapture(videopath)
    cnt = 0
    while True:
        ret, frame = cam.read()
        frame = cv2.rotate(frame, cv2.ROTATE_180)
        if not ret:
            break
        # 获取球的状态
        state = get_ball_state(frame)        
        # 绘制ROI矩形框
        cv2.rectangle(frame, (roi_x, roi_y), (roi_x + roi_width, roi_y + roi_height), (0, 255, 0), 2)
        # 显示球的状态
        cv2.putText(frame, state, (30, 50), cv2.FONT_HERSHEY_SIMPLEX, 1.2, (255, 255, 255), 3)
        # 展示处理后的帧
        cv2.imshow('Ball Color', frame)
        cv2.waitKey(25)
        # 按q键退出
        if cv2.waitKey(25) & 0xFF == ord('q'):
            break
        # 在while循环中进行你对frame的处理
    cam.release()
    video_process(r'res\output.avi')
    video_process(r'res\output1.avi')